<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar SCADA System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono:wght@400;500&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

<!-- Navbar -->
<nav class="scada-navbar d-flex justify-content-between align-items-center px-3">
    <div class="d-flex align-items-center gap-2">
        <i class="fas fa-solar-panel text-warning"></i>
        <span class="scada-font text-warning fw-bold">SOLAR</span><span class="scada-font text-light fw-bold">SCADA</span>
        <span class="ms-2 badge-live"><i class="fas fa-circle me-1"></i>LIVE</span>
    </div>
    <div class="d-flex align-items-center gap-3">
        <span class="nav-meta"><i class="fas fa-network-wired me-1"></i>Modbus <span class="text-info" id="nav-modbus-port">:5020</span></span>
        <span class="nav-meta"><i class="fas fa-globe me-1"></i>API <span class="text-info">:3000</span></span>
        <div class="nav-divider"></div>
        <span id="clock" class="font-monospace text-success small fw-bold">--:--:--</span>
    </div>
</nav>

<!-- App Shell -->
<div class="app-shell">

    <!-- ===== SIDEBAR ===== -->
    <aside class="sidebar d-flex flex-column">

        <!-- Sidebar Header (fixed) -->
        <div class="sidebar-header">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="text-uppercase text-muted small fw-bold">Fleet Overview</span>
                <span class="badge bg-secondary font-monospace" id="sb-plant-count">0</span>
            </div>
            <div class="fleet-kpi d-flex gap-2 mb-2">
                <div class="fleet-kpi-item flex-fill">
                    <div class="fki-label">TOTAL POWER</div>
                    <div class="fki-val text-warning" id="sb-total-power">— kW</div>
                </div>
                <div class="fleet-kpi-item flex-fill">
                    <div class="fki-label">ACTIVE</div>
                    <div class="fki-val text-success"><span id="sb-active">0</span>/<span id="sb-total">0</span></div>
                </div>
            </div>
            <div class="position-relative">
                <i class="fas fa-search position-absolute text-muted" style="left:9px;top:8px;font-size:10px;"></i>
                <input id="plant-search" type="text" class="form-control form-control-sm sidebar-search" placeholder="Filter plants…">
            </div>
        </div>

        <!-- Plant list (scrollable) -->
        <div class="sidebar-list flex-grow-1" id="plant-list">
            <div class="text-center p-4 text-muted">
                <div class="spinner-border spinner-border-sm text-primary mb-2" role="status"></div>
                <p class="mb-0 small">Loading…</p>
            </div>
        </div>

        <!-- Sidebar Footer -->
        <div class="sidebar-footer">
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">System</small>
                <span class="badge bg-success-subtle text-success-emphasis border border-success small" id="sb-sys-status">
                    <i class="fas fa-check-circle me-1"></i>Connected
                </span>
            </div>
            <small class="text-muted">Updated: <span id="sb-last-update" class="text-info font-monospace">--:--:--</span></small>
        </div>
    </aside>

    <!-- ===== MAIN CONTENT ===== -->
    <main class="main-content d-flex flex-column">

        <!-- MAP VIEW -->
        <div id="map-view" class="flex-grow-1 position-relative">
            <div id="map" style="height:100%;width:100%;"></div>
            <div class="map-overlay position-absolute top-0 end-0 m-3">
                <div class="text-warning scada-font small mb-2">GLOBAL METRICS</div>
                <div class="d-flex gap-3">
                    <div>
                        <div class="map-kpi-label">ACTIVE</div>
                        <div class="map-kpi-val"><span id="map-active">0</span>/<span id="map-total">0</span></div>
                    </div>
                    <div>
                        <div class="map-kpi-label">TOTAL OUTPUT</div>
                        <div class="map-kpi-val text-warning" id="map-total-power">— kW</div>
                    </div>
                    <div>
                        <div class="map-kpi-label">AVG EFFICIENCY</div>
                        <div class="map-kpi-val text-info" id="map-avg-eff">—%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DETAIL VIEW -->
        <div id="detail-view" class="d-none flex-grow-1 d-flex flex-column overflow-hidden">

            <!-- Detail Header -->
            <div class="detail-header d-flex justify-content-between align-items-center px-4 py-2">
                <div class="d-flex align-items-center gap-3">
                    <button class="btn btn-outline-secondary btn-sm" onclick="showMap()">
                        <i class="fas fa-arrow-left me-1"></i>Map
                    </button>
                    <div>
                        <h5 class="scada-font text-white mb-0" id="detail-name">Plant Name</h5>
                        <div class="d-flex align-items-center gap-2 mt-1">
                            <code class="text-muted small" id="detail-id">plant_id</code>
                            <span class="badge bg-dark border border-secondary font-monospace small" id="detail-local-time">--:--:--</span>
                        </div>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <div id="weather-icon-container"><i class="fas fa-sun fa-2x text-warning"></i></div>
                    <div class="text-end">
                        <span class="badge fs-6 px-3" id="detail-status">--</span>
                        <div class="mt-1"><small class="text-muted">Nominal: <span id="detail-nominal" class="text-white font-monospace">—</span> kW</small></div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="px-4 detail-tabs-bar">
                <button class="detail-tab active" data-tab="tab-kpi"><i class="fas fa-tachometer-alt me-1"></i>Live Data</button>
                <button class="detail-tab" data-tab="tab-chart"><i class="fas fa-chart-line me-1"></i>Chart</button>
                <button class="detail-tab" data-tab="tab-modbus"><i class="fas fa-network-wired me-1"></i>Modbus</button>
                <button class="detail-tab" data-tab="tab-info"><i class="fas fa-info-circle me-1"></i>Plant Info</button>
            </div>

            <!-- Tab Content -->
            <div class="flex-grow-1 overflow-auto p-4" id="tab-content-area">

                <!-- TAB: LIVE DATA -->
                <div id="tab-kpi" class="tab-panel">
                    <div class="row g-3 mb-3">
                        <div class="col-6 col-xl-3">
                            <div class="kpi-card">
                                <div class="kpi-card-label"><i class="fas fa-bolt text-warning me-1"></i>Active Power</div>
                                <div class="kpi-card-val text-warning" id="detail-power">— kW</div>
                                <div class="kpi-card-sub">
                                    <div class="mini-bar-track"><div class="mini-bar bg-warning" id="detail-power-bar" style="width:0%"></div></div>
                                    <span class="text-muted small" id="detail-power-pct">0% of nominal</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-xl-3">
                            <div class="kpi-card">
                                <div class="kpi-card-label"><i class="fas fa-plug text-info me-1"></i>Voltage</div>
                                <div class="kpi-card-val text-info" id="detail-voltage">— V</div>
                                <div class="kpi-card-sub text-muted small">AC Grid</div>
                            </div>
                        </div>
                        <div class="col-6 col-xl-3">
                            <div class="kpi-card">
                                <div class="kpi-card-label"><i class="fas fa-water text-primary me-1"></i>Current</div>
                                <div class="kpi-card-val text-white" id="detail-current">— A</div>
                                <div class="kpi-card-sub text-muted small">Phase RMS</div>
                            </div>
                        </div>
                        <div class="col-6 col-xl-3">
                            <div class="kpi-card">
                                <div class="kpi-card-label"><i class="fas fa-wave-square text-success me-1"></i>Frequency</div>
                                <div class="kpi-card-val text-white" id="detail-frequency">— Hz</div>
                                <div class="kpi-card-sub small" id="detail-freq-status">—</div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-6 col-xl-3">
                            <div class="kpi-card">
                                <div class="kpi-card-label"><i class="fas fa-thermometer-half text-danger me-1"></i>Temperature</div>
                                <div class="kpi-card-val" id="detail-temp-col">— °C</div>
                                <div class="kpi-card-sub text-muted small">Panel cell</div>
                            </div>
                        </div>
                        <div class="col-6 col-xl-3">
                            <div class="kpi-card">
                                <div class="kpi-card-label"><i class="fas fa-leaf text-success me-1"></i>Efficiency</div>
                                <div class="kpi-card-val text-success" id="detail-efficiency">— %</div>
                                <div class="kpi-card-sub"><div class="mini-bar-track"><div class="mini-bar bg-success" id="detail-eff-bar" style="width:0%"></div></div></div>
                            </div>
                        </div>
                        <div class="col-6 col-xl-3">
                            <div class="kpi-card">
                                <div class="kpi-card-label"><i class="fas fa-angle-double-right text-info me-1"></i>Power Factor</div>
                                <div class="kpi-card-val" id="detail-pf">—</div>
                                <div class="kpi-card-sub"><div class="mini-bar-track"><div class="mini-bar bg-info" id="detail-pf-bar" style="width:0%"></div></div></div>
                            </div>
                        </div>
                        <div class="col-6 col-xl-3">
                            <div class="kpi-card">
                                <div class="kpi-card-label"><i class="fas fa-database text-info me-1"></i>Daily Energy</div>
                                <div class="kpi-card-val text-info" id="detail-energy">— kWh</div>
                                <div class="kpi-card-sub text-muted small">Accumulated today</div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="scada-card">
                                <div class="scada-card-title"><i class="fas fa-vector-square me-2 text-warning"></i>Power Triangle</div>
                                <div class="row g-2 mt-1">
                                    <div class="col-4 text-center">
                                        <div class="power-tri-box border-warning">
                                            <div class="power-tri-label text-muted">P — Active</div>
                                            <div class="power-tri-val text-warning" id="pt-active">— kW</div>
                                        </div>
                                    </div>
                                    <div class="col-4 text-center">
                                        <div class="power-tri-box border-info">
                                            <div class="power-tri-label text-muted">S — Apparent</div>
                                            <div class="power-tri-val text-info" id="pt-apparent">— kVA</div>
                                        </div>
                                    </div>
                                    <div class="col-4 text-center">
                                        <div class="power-tri-box border-primary">
                                            <div class="power-tri-label text-muted">Q — Reactive</div>
                                            <div class="power-tri-val text-primary" id="pt-reactive">— kvar</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="scada-card">
                                <div class="scada-card-title"><i class="fas fa-solar-panel me-2 text-warning"></i>Array Visualization</div>
                                <div class="solar-viz-wrap position-relative overflow-hidden" style="height:110px;">
                                    <div class="solar-array">
                                        <div class="panel"></div><div class="panel"></div><div class="panel"></div>
                                        <div class="panel"></div><div class="panel"></div><div class="panel"></div>
                                    </div>
                                    <div class="sun-overlay" id="sun-visual"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: CHART -->
                <div id="tab-chart" class="tab-panel d-none">
                    <div class="scada-card mb-3">
                        <div class="scada-card-title d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-chart-line me-2 text-warning"></i>Power Generation History</span>
                            <small class="text-muted font-monospace">2s refresh · last 30 points</small>
                        </div>
                        <canvas id="powerChart" height="220"></canvas>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="scada-card text-center">
                                <div class="kpi-card-label mb-1">PEAK THIS SESSION</div>
                                <div class="kpi-card-val text-warning" id="chart-peak">— kW</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="scada-card text-center">
                                <div class="kpi-card-label mb-1">AVERAGE</div>
                                <div class="kpi-card-val text-info" id="chart-avg">— kW</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="scada-card text-center">
                                <div class="kpi-card-label mb-1">SAMPLES</div>
                                <div class="kpi-card-val text-muted" id="chart-samples">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: MODBUS -->
                <div id="tab-modbus" class="tab-panel d-none">

                    <div class="modbus-banner d-flex align-items-center justify-content-between mb-3">
                        <div class="d-flex align-items-center gap-3">
                            <div class="modbus-status-dot" id="mb-dot"></div>
                            <div>
                                <div class="fw-bold text-light">Modbus TCP Server</div>
                                <div class="small text-muted font-monospace" id="mb-addr">0.0.0.0:5020</div>
                            </div>
                        </div>
                        <div class="d-flex gap-4">
                            <div class="text-center">
                                <div class="mb-meta-label">PROTOCOL</div>
                                <div class="text-info small font-monospace">TCP/IP</div>
                            </div>
                            <div class="text-center">
                                <div class="mb-meta-label">ENCODING</div>
                                <div class="text-info small font-monospace">UInt16 BE</div>
                            </div>
                            <div class="text-center">
                                <div class="mb-meta-label">UNIT ID</div>
                                <div class="text-info small font-monospace">1</div>
                            </div>
                            <div class="text-center">
                                <div class="mb-meta-label">FUNC CODES</div>
                                <div class="text-info small font-monospace">03 / 04</div>
                            </div>
                            <div class="text-center">
                                <div class="mb-meta-label">REFRESH</div>
                                <div class="text-info small font-monospace">2s</div>
                            </div>
                        </div>
                    </div>

                    <div class="scada-card mb-3">
                        <div class="scada-card-title d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-table me-2 text-warning"></i>Register Map — <span id="mb-plant-id" class="font-monospace text-info">—</span></span>
                            <span class="badge bg-dark border border-secondary small font-monospace" id="mb-reg-count">—</span>
                        </div>
                        <div class="table-responsive mt-2">
                            <table class="table table-sm scada-table mb-0">
                                <thead>
                                    <tr>
                                        <th style="width:60px">Addr</th>
                                        <th>Variable</th>
                                        <th>Scaling</th>
                                        <th class="text-end">Raw u16</th>
                                        <th class="text-end">Decoded Value</th>
                                        <th style="width:70px">Unit</th>
                                        <th style="width:90px">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="mb-register-tbody">
                                    <tr><td colspan="7" class="text-center text-muted py-3 small">Select a plant to view registers</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <div class="scada-card">
                                <div class="scada-card-title"><i class="fas fa-microchip me-2 text-info"></i>Encoding — IEEE 754 float32</div>
                                <table class="table table-sm scada-table mb-0 mt-2">
                                    <thead><tr><th>Variable</th><th>Registers</th><th>Encoding</th><th>Unit</th></tr></thead>
                                    <tbody>
                                        <tr><td>Power</td><td class="font-monospace text-warning">addr, addr+1</td><td class="text-muted font-monospace">IEEE 754 f32</td><td class="text-muted">kW</td></tr>
                                        <tr><td>Voltage</td><td class="font-monospace text-warning">addr, addr+1</td><td class="text-muted font-monospace">IEEE 754 f32</td><td class="text-muted">V</td></tr>
                                        <tr><td>Current</td><td class="font-monospace text-warning">addr, addr+1</td><td class="text-muted font-monospace">IEEE 754 f32</td><td class="text-muted">A</td></tr>
                                        <tr><td>Frequency</td><td class="font-monospace text-warning">addr, addr+1</td><td class="text-muted font-monospace">IEEE 754 f32</td><td class="text-muted">Hz</td></tr>
                                        <tr><td>Temperature</td><td class="font-monospace text-warning">addr, addr+1</td><td class="text-muted font-monospace">IEEE 754 f32</td><td class="text-muted">°C</td></tr>
                                        <tr><td>Status</td><td class="font-monospace text-secondary">addr</td><td class="text-muted font-monospace">u16 raw</td><td class="text-muted">—</td></tr>
                                    </tbody>
                                </table>
                                <p class="text-muted small mt-2 mb-0">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Decode: <code class="text-info">raw = (hi &lt;&lt; 16) | lo &nbsp;→&nbsp; struct.unpack('!f', struct.pack('!I', raw))[0]</code>
                                </p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="scada-card">
                                <div class="scada-card-title"><i class="fab fa-python me-2 text-warning"></i>Python Snippet (pymodbus)</div>
                                <pre class="code-snippet mb-0 mt-2" id="mb-code-snippet"><!-- rendered by JS --></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: PLANT INFO -->
                <div id="tab-info" class="tab-panel d-none">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="scada-card h-100">
                                <div class="scada-card-title"><i class="fas fa-id-card me-2 text-warning"></i>Identity</div>
                                <table class="table table-sm scada-table mb-0 mt-2">
                                    <tbody>
                                        <tr><td class="text-muted">Plant ID</td><td class="font-monospace text-info" id="info-id">—</td></tr>
                                        <tr><td class="text-muted">Name</td><td id="info-name">—</td></tr>
                                        <tr><td class="text-muted">Timezone</td><td class="font-monospace" id="info-tz">—</td></tr>
                                        <tr><td class="text-muted">Nominal Power</td><td class="font-monospace" id="info-nominal">—</td></tr>
                                        <tr><td class="text-muted">Update Interval</td><td class="font-monospace">5 seconds</td></tr>
                                        <tr><td class="text-muted">Weather Source</td><td class="font-monospace text-info">Open-Meteo API</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="scada-card h-100">
                                <div class="scada-card-title"><i class="fas fa-map-marker-alt me-2 text-warning"></i>Location</div>
                                <table class="table table-sm scada-table mb-0 mt-2">
                                    <tbody>
                                        <tr><td class="text-muted">Latitude</td><td class="font-monospace" id="info-lat">—</td></tr>
                                        <tr><td class="text-muted">Longitude</td><td class="font-monospace" id="info-lon">—</td></tr>
                                    </tbody>
                                </table>
                                <div id="info-mini-map" style="height:120px; border-radius:8px; overflow:hidden; margin-top:10px;"></div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="scada-card">
                                <div class="scada-card-title"><i class="fas fa-network-wired me-2 text-warning"></i>Modbus Register Addresses</div>
                                <div class="row g-2 mt-1" id="info-modbus-mapping"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div><!-- /tab-content-area -->
        </div><!-- /detail-view -->

    </main>
</div><!-- /app-shell -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="js/app.js"></script>
</body>
</html>